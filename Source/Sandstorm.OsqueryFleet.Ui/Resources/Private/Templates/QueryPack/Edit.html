{namespace crud=Sandstorm\CrudForms\ViewHelpers}
<f:layout name="Default"/>

<f:section name="Content">

    <f:flashMessages class="flashmessages"/>

    <f:form action="update" objectName="object" object="{object}" enctype="multipart/form-data">
        <f:render partial="CrudForms/Bootstrap4/Form" arguments="{crud:formDefinition(object: object, model: model)}" />

        <div id="editor">
        </div>

        <f:form.hidden property="sourceJson" id="sourceJson" />

        <script>
            var processed = {object.processedJson -> f:format.json() -> f:format.raw()};
            var previewUrl = {f:uri.action(action: 'preview') -> f:format.json() -> f:format.raw()};

            <![CDATA[
            var target = document.getElementById("editor");
            var value = $('#sourceJson').val();
            var dv = CodeMirror.MergeView(target, {
                value: value,
                origLeft: null,
                orig: processed,
                lineNumbers: true,
                mode: "json",
                highlightDifferences: true,
                collapseIdentical: false,
                revertButtons: false
            });
            dv.editor().on('change', function() {
                $('#sourceJson').val(dv.editor().getValue());
                updateDiff();
            })

            function updateDiff() {
                fetch(previewUrl, {
                    method: "POST",
                    credentials: 'same-origin',
                    body: $('#editor').closest('form').serialize()
                }).then(function(response) {
                    return response.text();
                }).then(function(responseText) {
                    dv.rightOriginal().setValue(responseText);
                });

            }

            var debounceTimer = null;
            jQuery('#jqTransformationRules').on('keyup', function() {
                if (debounceTimer) {
                    window.clearTimeout(debounceTimer);
                    debounceTimer = null;
                }
                debounceTimer = window.setTimeout(updateDiff, 100);
            });
            ]]>
        </script>

        <f:link.action action="index" class="button">Cancel</f:link.action>
        <f:form.submit value="save" class="btn btn-primary" />
    </f:form>

</f:section>

